group:
  car_sensors:
    name:                  Car sensors
    entities:
      - binary_sensor.carpresence
      - sensor.carpresencesignal
      - sensor.carpresenceuptime
hangouts:
  intents:
    ArriveLate:
      sentences:
        - Turn off lights

intent_script:
  ArriveLate:
    speech:
      text:                'Turning off the lights'
    action:
    - service:             light.turn_off
      entity_id:
        - light.her_light
        - light.his_light
    - service:             light.turn_off
      entity_id:           light.cabinets

automation:
  # car sensor is connected and the garage door is closed
  - alias:                 CarPresence_ON
    initial_state:         on
    trigger:
      platform:            state
      entity_id:           binary_sensor.carpresence
      to:                  'on'
    condition:
    - condition:           state
      entity_id:           'sensor.garage_door'
      state:               'closed'
    action:
    - service:             cover.open_cover
      entity_id:           'cover.garage_door'

  # car sensor is disconnected for and the garage door is open
  - alias:                 CarPresence_OFF
    initial_state:         on
    trigger:
      platform:            state
      entity_id:           binary_sensor.carpresence
      to:                  'off'
    condition:
    - condition:           state
      entity_id:           'sensor.garage_door'
      state:               'open'
    action:
    - service:             cover.close_cover
      entity_id:           'cover.garage_door'

  - alias:                 Arrive Home Late
    initial_state:         on
    trigger:
      - platform:          state
        entity_id:         binary_sensor.carpresence
        to:                'off'
        for:
          minutes:         2
    condition:
      - condition:         time
        after:             '22:00:00'
        before:            '06:00:00'
    action:
      - service:           light.turn_on
        entity_id:
          - light.her_light
          - light.his_light
        data:
          brightness_pct:  25
      - service:           light.turn_on
        entity_id:         light.cabinets
      - delay:
          minutes:         10
      - service:           light.turn_off
        entity_id:
          - light.her_light
          - light.his_light
      - service:           light.turn_off
        entity_id:         light.cabinets
      - service:           notify.html5_notify
        data:
          message:         'Welcome home'
          data:
            actions:
              - action:    "turn_off_lights"
                title:     "Turn Off Lights"
            tag:           late_arrival_notification
      - service:           hangouts.send_message
        data:
          target:          [{"name":"Panda Pad"}]
          message:         [{"text":"Welcome Home. Type 'Turn off lights' to turn off all lights."}]

  - id:                    LateArrivalNotificationClicked
    alias:                 "Late Arrival Notification Clicked"
    initial_state:         on
    trigger:
    - platform:            event
      event_type:          html5_notification.clicked
      event_data:
        action:            turn_off_lights
    action:
    - service:             light.turn_off
      entity_id:
        - light.her_light
        - light.his_light
    - service:             light.turn_off
      entity_id:           light.cabinets
